{% extends "base.html" %}

{% block title %}Test Template: {{ email_template.name }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Test Template: <code>{{ email_template.name }}</code></h2>
    <div class="d-flex gap-2">
        <button type="button" class="btn btn-outline-info btn-sm" data-bs-toggle="modal" data-bs-target="#syntaxRefModal">
            Template Syntax Reference
        </button>
        <a href="{% url 'notifications:template_edit' email_template.pk %}" class="btn btn-outline-primary btn-sm">Edit Template</a>
        <a href="{% url 'notifications:template_list' %}" class="btn btn-outline-secondary btn-sm">Back to List</a>
    </div>
</div>

<div class="row">
    <!-- Left: Variable inputs + send test -->
    <div class="col-lg-5">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Template Variables</h5>
            </div>
            <div class="card-body">
                {% if variables %}
                <p class="text-muted small">Fill in values for each variable used in this template, then click Preview or Send Test.</p>
                <form method="post" action="{% url 'notifications:template_preview' email_template.pk %}" id="previewForm">
                    {% csrf_token %}
                    {% for var in variables %}
                    <div class="mb-2">
                        <label class="form-label fw-bold mb-0">
                            <code>{{ "{{" }} {{ var.name }} {{ "}}" }}</code>
                        </label>
                        <input type="text" class="form-control form-control-sm" name="var_{{ var.name }}"
                               value="{{ var.current_value|default:'' }}"
                               placeholder="{{ var.sample }}">
                    </div>
                    {% endfor %}
                    <div class="d-flex gap-2 mt-3">
                        <button type="submit" class="btn btn-primary btn-sm">Preview</button>
                    </div>
                </form>

                <hr>

                <form method="post" action="{% url 'notifications:template_test_send' email_template.pk %}" id="testSendForm">
                    {% csrf_token %}
                    {% for var in variables %}
                    <input type="hidden" name="var_{{ var.name }}" value="" class="testvar-hidden">
                    {% endfor %}
                    <div class="mb-2">
                        <label class="form-label fw-bold mb-0">Send test email to:</label>
                        <div class="input-group input-group-sm">
                            <input type="email" class="form-control" name="test_email" placeholder="you@example.com" required>
                            <button type="submit" class="btn btn-warning">Send Test</button>
                        </div>
                        <div class="form-text">Sends a real email using the variable values above.</div>
                    </div>
                </form>
                {% else %}
                <p class="text-muted">No template variables detected in this template.</p>
                <form method="post" action="{% url 'notifications:template_preview' email_template.pk %}">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-primary btn-sm">Preview</button>
                </form>
                {% endif %}
            </div>
        </div>

        <!-- Template info -->
        <div class="card mb-4">
            <div class="card-header"><h6 class="mb-0">Template Info</h6></div>
            <div class="card-body small">
                <table class="table table-sm mb-0">
                    <tr><th>Name</th><td><code>{{ email_template.name }}</code></td></tr>
                    <tr><th>Subject</th><td>{{ email_template.subject }}</td></tr>
                    <tr><th>Active</th><td>{% if email_template.is_active %}<span class="badge bg-success">Yes</span>{% else %}<span class="badge bg-secondary">No</span>{% endif %}</td></tr>
                    {% if email_template.description %}
                    <tr><th>Description</th><td>{{ email_template.description }}</td></tr>
                    {% endif %}
                </table>
            </div>
        </div>
    </div>

    <!-- Right: Rendered preview -->
    <div class="col-lg-7">
        {% if rendered_html %}
        <div class="card mb-3">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">Rendered Preview</h5>
            </div>
            {% if rendered_subject %}
            <div class="card-header">
                <strong>Subject:</strong> {{ rendered_subject }}
            </div>
            {% endif %}
            <div class="card-body">
                <div class="border rounded p-3 bg-white">
                    {{ rendered_html|safe }}
                </div>
            </div>
        </div>
        {% else %}
        <div class="card">
            <div class="card-body text-center text-muted py-5">
                <p class="mb-0">Click <strong>Preview</strong> to render the template with your variable values.</p>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Syntax Reference Modal -->
<div class="modal fade" id="syntaxRefModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Django Template Syntax Reference</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Variables -->
                <h6 class="fw-bold mt-0">Variables</h6>
                <p>Insert dynamic values using double curly braces:</p>
                <table class="table table-sm table-bordered">
                    <thead class="table-light">
                        <tr><th>Syntax</th><th>Description</th><th>Example Output</th></tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><code>{{ "{{ display_name }}" }}</code></td>
                            <td>User's full display name</td>
                            <td>John Doe</td>
                        </tr>
                        <tr>
                            <td><code>{{ "{{ username }}" }}</code></td>
                            <td>User's sAMAccountName (login name)</td>
                            <td>jdoe</td>
                        </tr>
                        <tr>
                            <td><code>{{ "{{ email }}" }}</code></td>
                            <td>User's email address</td>
                            <td>jdoe@example.com</td>
                        </tr>
                        <tr>
                            <td><code>{{ "{{ domain }}" }}</code></td>
                            <td>Active Directory domain name</td>
                            <td>EXAMPLE</td>
                        </tr>
                        <tr>
                            <td><code>{{ "{{ temporary_password }}" }}</code></td>
                            <td>Temporary password (welcome emails)</td>
                            <td>T3mp!Pass_Ex@mple</td>
                        </tr>
                        <tr>
                            <td><code>{{ "{{ days_until_expiry }}" }}</code></td>
                            <td>Days until password expires</td>
                            <td>7</td>
                        </tr>
                        <tr>
                            <td><code>{{ "{{ expiry_date }}" }}</code></td>
                            <td>Password expiration date</td>
                            <td>March 15, 2026</td>
                        </tr>
                        <tr>
                            <td><code>{{ "{{ reset_link }}" }}</code></td>
                            <td>Password reset URL</td>
                            <td>https://admanager.example.com/...</td>
                        </tr>
                    </tbody>
                </table>
                <div class="alert alert-info small">
                    <strong>Tip:</strong> You can use any variable name you want. Just include <code>{{ "{{ my_variable }}" }}</code> in the template, and provide a value when sending. The variables above are automatically available in system-triggered emails.
                </div>

                <!-- Filters -->
                <h6 class="fw-bold mt-4">Filters</h6>
                <p>Transform variables with the pipe (<code>|</code>) character:</p>
                <table class="table table-sm table-bordered">
                    <thead class="table-light">
                        <tr><th>Syntax</th><th>Description</th><th>Example</th></tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><code>{{ "{{ display_name|upper }}" }}</code></td>
                            <td>Convert to UPPERCASE</td>
                            <td>JOHN DOE</td>
                        </tr>
                        <tr>
                            <td><code>{{ "{{ display_name|lower }}" }}</code></td>
                            <td>Convert to lowercase</td>
                            <td>john doe</td>
                        </tr>
                        <tr>
                            <td><code>{{ "{{ display_name|title }}" }}</code></td>
                            <td>Title Case</td>
                            <td>John Doe</td>
                        </tr>
                        <tr>
                            <td><code>{{ "{{ display_name|truncatewords:3 }}" }}</code></td>
                            <td>Truncate to N words</td>
                            <td>John Doe ...</td>
                        </tr>
                        <tr>
                            <td><code>{{ "{{ email|default:'N/A' }}" }}</code></td>
                            <td>Fallback if variable is empty</td>
                            <td>N/A</td>
                        </tr>
                        <tr>
                            <td><code>{{ "{{ days_until_expiry|add:1 }}" }}</code></td>
                            <td>Add to a number</td>
                            <td>8</td>
                        </tr>
                    </tbody>
                </table>

                <!-- Conditionals -->
                <h6 class="fw-bold mt-4">Conditionals</h6>
                <p>Show content only when conditions are met:</p>
                <pre class="bg-light p-2 rounded"><code>{% verbatim %}{% if days_until_expiry <= 3 %}
  &lt;p style="color: red;"&gt;&lt;strong&gt;URGENT:&lt;/strong&gt; Your password expires very soon!&lt;/p&gt;
{% elif days_until_expiry <= 7 %}
  &lt;p style="color: orange;"&gt;Your password expires in {{ days_until_expiry }} days.&lt;/p&gt;
{% else %}
  &lt;p&gt;Your password expires in {{ days_until_expiry }} days.&lt;/p&gt;
{% endif %}{% endverbatim %}</code></pre>

                <pre class="bg-light p-2 rounded"><code>{% verbatim %}{% if temporary_password %}
  &lt;p&gt;Your temporary password is: &lt;code&gt;{{ temporary_password }}&lt;/code&gt;&lt;/p&gt;
{% endif %}{% endverbatim %}</code></pre>

                <!-- Loops -->
                <h6 class="fw-bold mt-4">Loops</h6>
                <p>Iterate over lists (if a variable contains a list):</p>
                <pre class="bg-light p-2 rounded"><code>{% verbatim %}{% for item in items %}
  &lt;li&gt;{{ item }}&lt;/li&gt;
{% empty %}
  &lt;li&gt;No items found.&lt;/li&gt;
{% endfor %}{% endverbatim %}</code></pre>

                <!-- Full Example -->
                <h6 class="fw-bold mt-4">Full Example: Custom Announcement</h6>
                <pre class="bg-light p-2 rounded"><code>{% verbatim %}&lt;h2&gt;Hello {{ display_name }},&lt;/h2&gt;

&lt;p&gt;This is a message from the {{ domain }} IT team.&lt;/p&gt;

{% if action_required %}
&lt;div style="background: #fff3cd; padding: 15px; border-radius: 4px;"&gt;
  &lt;strong&gt;Action Required:&lt;/strong&gt; {{ action_message }}
&lt;/div&gt;
{% endif %}

&lt;p&gt;If you have questions, contact us at {{ support_email|default:"it@example.com" }}.&lt;/p&gt;{% endverbatim %}</code></pre>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Sync variable values from preview form to test-send form hidden fields
    const previewForm = document.getElementById('previewForm');
    const testSendForm = document.getElementById('testSendForm');

    if (previewForm && testSendForm) {
        testSendForm.addEventListener('submit', function() {
            const hiddenFields = testSendForm.querySelectorAll('.testvar-hidden');
            hiddenFields.forEach(function(hidden) {
                const name = hidden.name;
                const source = previewForm.querySelector('[name="' + name + '"]');
                if (source) {
                    hidden.value = source.value;
                }
            });
        });

        // Pre-fill with sample values on load if fields are empty
        previewForm.querySelectorAll('input[name^="var_"]').forEach(function(input) {
            if (!input.value && input.placeholder) {
                input.value = input.placeholder;
            }
        });
    }
});
</script>
{% endblock %}
