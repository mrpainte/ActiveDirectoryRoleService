{% extends "base.html" %}

{% block title %}Send Email{% endblock %}

{% block content %}
{% include "notifications/_nav.html" with active_tab="send" %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Send Email</h2>
</div>

{% if form.errors %}
<div class="alert alert-danger">
    {% for error in form.non_field_errors %}
    <p class="mb-0">{{ error }}</p>
    {% endfor %}
</div>
{% endif %}

<form method="post" id="sendEmailForm">
    {% csrf_token %}

    <!-- Recipients Section -->
    <div class="card mb-4">
        <div class="card-header"><h5 class="mb-0">Recipients</h5></div>
        <div class="card-body">
            <div class="mb-3">
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="recipient_type" id="rt_emails" value="emails"
                           {% if not form.recipient_type.value or form.recipient_type.value == 'emails' %}checked{% endif %}>
                    <label class="form-check-label" for="rt_emails">Specific email addresses</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="recipient_type" id="rt_group" value="group"
                           {% if form.recipient_type.value == 'group' %}checked{% endif %}>
                    <label class="form-check-label" for="rt_group">All members of an AD group</label>
                </div>
            </div>

            <!-- Email list panel -->
            <div id="emailsPanel" {% if form.recipient_type.value == 'group' %}style="display:none"{% endif %}>
                <label class="form-label">Email Addresses</label>
                {{ form.recipient_emails }}
                <div class="form-text">One email address per line.</div>
            </div>

            <!-- Group search panel -->
            <div id="groupPanel" {% if form.recipient_type.value != 'group' %}style="display:none"{% endif %}>
                <label class="form-label">Search for a Group</label>
                <input type="text" class="form-control mb-2" id="groupSearchInput" placeholder="Type to search groups...">
                <input type="hidden" name="group_dn" id="groupDnInput" value="{{ form.group_dn.value|default:'' }}">
                <div id="groupSearchResults" class="list-group mb-2"></div>
                <div id="selectedGroup" class="alert alert-info" style="display:none">
                    Selected: <strong id="selectedGroupName"></strong>
                    <button type="button" class="btn-close btn-sm float-end" id="clearGroup"></button>
                </div>
            </div>
        </div>
    </div>

    <!-- Content Section -->
    <div class="card mb-4">
        <div class="card-header"><h5 class="mb-0">Email Content</h5></div>
        <div class="card-body">
            <div class="form-check mb-3">
                {{ form.use_template }}
                <label class="form-check-label" for="id_use_template">Start from an existing template</label>
            </div>

            <div id="templatePicker" style="display:none" class="mb-3">
                <label class="form-label">Template</label>
                {{ form.template_id }}
                <button type="button" class="btn btn-sm btn-outline-primary mt-1" id="loadTemplateBtn">Load Template</button>
            </div>

            <div class="mb-3">
                <label class="form-label">Subject</label>
                {{ form.subject }}
                {% if form.subject.errors %}<div class="invalid-feedback d-block">{{ form.subject.errors.0 }}</div>{% endif %}
                <div class="form-text">
                    Supports Django template variables: <code>{% verbatim %}{{ domain }}{% endverbatim %}</code>
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label">HTML Body</label>
                {{ form.body_html }}
                {% if form.body_html.errors %}<div class="invalid-feedback d-block">{{ form.body_html.errors.0 }}</div>{% endif %}
            </div>

            <div class="mb-3">
                <label class="form-label">Plain Text Body <span class="text-muted">(optional)</span></label>
                {{ form.body_text }}
            </div>
        </div>
    </div>

    <div class="d-flex gap-2">
        <button type="submit" class="btn btn-primary">Send Email</button>
        <a href="{% url 'notifications:history' %}" class="btn btn-outline-secondary">Cancel</a>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const rtEmails = document.getElementById('rt_emails');
    const rtGroup = document.getElementById('rt_group');
    const emailsPanel = document.getElementById('emailsPanel');
    const groupPanel = document.getElementById('groupPanel');
    const useTemplate = document.getElementById('id_use_template');
    const templatePicker = document.getElementById('templatePicker');
    const groupSearchInput = document.getElementById('groupSearchInput');
    const groupSearchResults = document.getElementById('groupSearchResults');
    const groupDnInput = document.getElementById('groupDnInput');
    const selectedGroup = document.getElementById('selectedGroup');
    const selectedGroupName = document.getElementById('selectedGroupName');
    const clearGroupBtn = document.getElementById('clearGroup');
    const loadTemplateBtn = document.getElementById('loadTemplateBtn');

    // Toggle recipient panels
    function toggleRecipient() {
        if (rtEmails.checked) {
            emailsPanel.style.display = '';
            groupPanel.style.display = 'none';
        } else {
            emailsPanel.style.display = 'none';
            groupPanel.style.display = '';
        }
    }
    rtEmails.addEventListener('change', toggleRecipient);
    rtGroup.addEventListener('change', toggleRecipient);

    // Toggle template picker
    useTemplate.addEventListener('change', function() {
        templatePicker.style.display = this.checked ? '' : 'none';
    });
    if (useTemplate.checked) templatePicker.style.display = '';

    // Group search
    let searchTimeout;
    groupSearchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        const q = this.value.trim();
        if (q.length < 2) {
            groupSearchResults.innerHTML = '';
            return;
        }
        searchTimeout = setTimeout(function() {
            fetch('{% url "notifications:group_search" %}?q=' + encodeURIComponent(q))
                .then(r => r.json())
                .then(data => {
                    groupSearchResults.innerHTML = '';
                    data.results.forEach(function(g) {
                        const item = document.createElement('button');
                        item.type = 'button';
                        item.className = 'list-group-item list-group-item-action';
                        item.innerHTML = '<strong>' + g.name + '</strong>';
                        if (g.description) item.innerHTML += '<br><small class="text-muted">' + g.description + '</small>';
                        item.addEventListener('click', function() {
                            groupDnInput.value = g.dn;
                            selectedGroupName.textContent = g.name;
                            selectedGroup.style.display = '';
                            groupSearchResults.innerHTML = '';
                            groupSearchInput.value = '';
                        });
                        groupSearchResults.appendChild(item);
                    });
                });
        }, 300);
    });

    // Clear selected group
    clearGroupBtn.addEventListener('click', function() {
        groupDnInput.value = '';
        selectedGroup.style.display = 'none';
    });

    // Load template content
    loadTemplateBtn.addEventListener('click', function() {
        const select = document.getElementById('id_template_id');
        const pk = select.value;
        if (!pk) return;

        // Fetch the template via the preview endpoint and extract raw fields
        // We'll use the Django API - for now just load the selected option's data
        // Use a simple approach: fetch the edit page and parse, or store data in attrs
        // Simplest: use the name from the option and load via a quick fetch
        const opt = select.options[select.selectedIndex];
        if (opt) {
            // Load template by fetching its preview - but we need raw content
            // For now, redirect to fill from the template URL param
            window.location.href = '{% url "notifications:send_email" %}?template_id=' + pk;
        }
    });

    // Show selected group if already set
    if (groupDnInput.value) {
        selectedGroup.style.display = '';
        selectedGroupName.textContent = groupDnInput.value.split(',')[0].replace('CN=', '');
    }
});
</script>
{% endblock %}
