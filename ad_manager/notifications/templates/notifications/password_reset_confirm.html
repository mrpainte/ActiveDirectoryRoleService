{% extends "base.html" %}

{% block title %}Set New Password{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-6 col-lg-5">
        <div class="card shadow-sm">
            <div class="card-body p-4">
                <h3 class="card-title text-center mb-4">Set New Password</h3>

                {% if messages %}
                {% for message in messages %}
                <div class="alert {{ message.tags }}">{{ message }}</div>
                {% endfor %}
                {% endif %}

                {% if form.errors %}
                <div class="alert alert-danger">
                    {% for error in form.non_field_errors %}
                    <p class="mb-0">{{ error }}</p>
                    {% endfor %}
                </div>
                {% endif %}

                <form method="post">
                    {% csrf_token %}

                    <div class="mb-3">
                        <label class="form-label">New Password</label>
                        {{ form.new_password }}
                        {% if form.new_password.errors %}
                        <div class="invalid-feedback d-block">{{ form.new_password.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Confirm Password</label>
                        {{ form.confirm_password }}
                        {% if form.confirm_password.errors %}
                        <div class="invalid-feedback d-block">{{ form.confirm_password.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <div id="ssPasswordRules" class="mb-3">
                        <small class="text-muted">Password requirements:</small>
                        <ul class="list-unstyled mb-0 ms-2">
                            <li id="ss-rule-length"><small class="text-muted">&#9679; At least 15 characters</small></li>
                            <li id="ss-rule-upper"><small class="text-muted">&#9679; At least 1 uppercase letter</small></li>
                            <li id="ss-rule-lower"><small class="text-muted">&#9679; At least 1 lowercase letter</small></li>
                            <li id="ss-rule-number"><small class="text-muted">&#9679; At least 1 number</small></li>
                            <li id="ss-rule-special"><small class="text-muted">&#9679; At least 1 special character</small></li>
                            <li id="ss-rule-match"><small class="text-muted">&#9679; Passwords match</small></li>
                        </ul>
                    </div>

                    <button type="submit" class="btn btn-primary w-100">Reset Password</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const pwField = document.querySelector('[name="new_password"]');
    const confirmField = document.querySelector('[name="confirm_password"]');

    if (!pwField || !confirmField) return;

    const rules = {
        length:  { el: document.getElementById('ss-rule-length'),  test: pw => pw.length >= 15 },
        upper:   { el: document.getElementById('ss-rule-upper'),   test: pw => /[A-Z]/.test(pw) },
        lower:   { el: document.getElementById('ss-rule-lower'),   test: pw => /[a-z]/.test(pw) },
        number:  { el: document.getElementById('ss-rule-number'),  test: pw => /[0-9]/.test(pw) },
        special: { el: document.getElementById('ss-rule-special'), test: pw => /[^A-Za-z0-9]/.test(pw) },
        match:   { el: document.getElementById('ss-rule-match'),   test: pw => pw && pw === confirmField.value },
    };

    function checkRules() {
        const pw = pwField.value;
        for (const [key, rule] of Object.entries(rules)) {
            const passed = rule.test(pw);
            const small = rule.el.querySelector('small');
            if (passed) {
                small.className = 'text-success';
                small.innerHTML = small.innerHTML.replace('&#9679;', '&#10003;').replace('\u25CF', '\u2713');
            } else {
                small.className = 'text-muted';
                small.innerHTML = small.innerHTML.replace('&#10003;', '&#9679;').replace('\u2713', '\u25CF');
            }
        }
    }

    pwField.addEventListener('input', checkRules);
    confirmField.addEventListener('input', checkRules);
});
</script>
{% endblock %}
